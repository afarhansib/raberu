<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Raberu - Price Label Printer</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: { extend: { fontFamily: { sans: ["Inter", "sans-serif"] } } },
      };
    </script>
  </head>
  <body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-6">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1
          class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2"
        >
          üè∑Ô∏è Raberu
        </h1>
        <p class="text-slate-600">CSV Price Label Printer</p>
      </div>

      <!-- CSV Input -->
      <div
        class="bg-white rounded-2xl shadow-xl p-6 mb-8 border border-slate-100"
      >
        <h3 class="text-lg font-semibold text-slate-800 mb-4">üìã Paste CSV</h3>
        <textarea
          v-model="csvInput"
          @input="parseCsv"
          placeholder="nama,harga&#10;See U Napkin,16000&#10;Paseo Travel Pack,3000"
          rows="6"
          class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all font-mono text-sm"
        ></textarea>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Items List -->
        <div class="bg-white rounded-2xl shadow-xl p-6 border border-slate-100">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-slate-800">
              Items ({{ filteredItems.length }})
            </h3>
            <button
              @click="addToQueue"
              :disabled="selectedItems.length === 0"
              class="px-4 bg-indigo-600 text-white py-2 rounded-xl text-sm font-semibold"
            >
              ‚ûï Add Selected
            </button>
            <input
              v-model="searchQuery"
              placeholder="üîç Search..."
              class="px-3 py-2 border border-slate-200 rounded-xl text-sm w-48 focus:ring-2 focus:ring-indigo-500"
            />
          </div>

          <div
            v-if="items.length === 0"
            class="text-center py-12 text-slate-500"
          >
            <p>Paste CSV above to load items</p>
          </div>

          <div v-else class="space-y-3 max-h-96 overflow-y-auto">
            <div
              v-for="item in filteredItems"
              :key="item.nama"
              class="flex items-center p-4 bg-gradient-to-r from-slate-50 to-indigo-50 rounded-xl border border-slate-200 hover:shadow-md transition-all"
            >
              <input
                type="checkbox"
                v-model="selectedItems"
                :value="item"
                class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 mr-3"
              />
              <div class="flex-1">
                <div class="font-semibold text-slate-800">{{ item.nama }}</div>
                <div class="text-lg font-bold text-indigo-600">
                  Rp {{ formatPrice(item.harga) }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Print Queue -->
        <div class="bg-white rounded-2xl shadow-xl p-6 border border-slate-100">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-slate-800">
              Print Queue ({{ printQueue.length }})
            </h2>
            <button
              @click="printAll"
              :disabled="printQueue.length === 0"
              class="bg-gradient-to-r from-emerald-500 to-teal-600 text-white px-6 py-2 rounded-xl font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
            >
              üñ®Ô∏è Print All
            </button>
          </div>

          <div class="space-y-3">
            <div
              v-for="(item, index) in printQueue"
              :key="index"
              class="flex items-center justify-between p-4 bg-gradient-to-r from-slate-50 to-emerald-50 rounded-xl border border-slate-200 hover:shadow-md transition-all"
            >
              <div>
                <div class="font-semibold text-slate-800">{{ item.nama }}</div>
                <div class="text-2xl font-bold text-emerald-600">
                  Rp {{ formatPrice(item.harga) }}
                </div>
              </div>
              <button
                @click="removeFromQueue(index)"
                class="text-red-500 hover:text-red-700 font-semibold p-2 hover:bg-red-100 rounded-full transition-colors"
              >
                üóëÔ∏è
              </button>
            </div>

            <div
              v-if="printQueue.length === 0"
              class="text-center py-12 text-slate-500"
            >
              <div
                class="w-16 h-16 bg-slate-100 rounded-2xl mx-auto mb-4 flex items-center justify-center"
              >
                üìã
              </div>
              <p>Select items from list above</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Printer selection (same as before) -->
      <div
        class="bg-white rounded-2xl shadow-xl p-4 mt-8 border border-slate-100"
      >
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-slate-800">Printer</h3>
          <button
            @click="loadPrinters"
            class="text-sm px-3 py-1 rounded-lg bg-slate-100 hover:bg-slate-200"
          >
            üîÑ Scan
          </button>
        </div>

        <div v-if="printers.length === 0" class="text-sm text-slate-500">
          No paired printers found. Pair your Bluetooth printer in system
          settings, then tap Scan.
        </div>

        <div v-else class="space-y-2">
          <select
            v-model="selectedPrinter"
            @change="onPrinterChange"
            class="w-full border border-slate-200 rounded-xl px-3 py-2 text-sm"
          >
            <option v-for="p in printers" :key="p.address" :value="p.address">
              {{ p.name }} ({{ p.address }})
            </option>
          </select>

          <button
            @click="testPrint"
            class="w-full mt-2 bg-emerald-500 text-white py-2 rounded-xl text-sm font-semibold"
          >
            üñ®Ô∏è Test print
          </button>
        </div>
      </div>
    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            csvInput: "",
            items: [],
            searchQuery: "",
            selectedItems: [],
            printQueue: [],
            printers: [],
            selectedPrinter: null,
            product: { name: "", price: "" },
          };
        },
        computed: {
          filteredItems() {
            if (!this.searchQuery) return this.items;
            const q = this.searchQuery.toLowerCase();
            return this.items.filter(
              (item) =>
                item.nama.toLowerCase().includes(q) ||
                this.formatPrice(item.harga).includes(q)
            );
          },
        },
        methods: {
          parseCsv() {
            try {
              const lines = this.csvInput.trim().split("\n");
              if (lines.length < 2) {
                this.items = [];
                return;
              }

              const headers = lines[0].split(",");
              const namaIdx = headers.indexOf("nama");
              const hargaIdx = headers.indexOf("harga");

              if (namaIdx === -1 || hargaIdx === -1) {
                console.error("CSV must have 'nama' and 'harga' columns");
                return;
              }

              this.items = lines.slice(1).map((line) => {
                const cols = line.split(",");
                return {
                  nama: cols[namaIdx] || "",
                  harga: Number(cols[hargaIdx]) || 0,
                };
              });
            } catch (e) {
              console.error("CSV parse error:", e);
            }
          },
          formatPrice(value) {
            const n = Number(value || 0);
            return n.toLocaleString("id-ID", {
              minimumFractionDigits: 0,
              maximumFractionDigits: 0,
              useGrouping: true,
            });
          },
          addToQueue() {
            if (this.selectedItems.length > 0) {
              this.printQueue.push(...this.selectedItems);
              this.selectedItems = [];
            }
          },
          removeFromQueue(index) {
            this.printQueue.splice(index, 1);
          },
          onPrinterChange() {
            if (this.selectedPrinter) {
              localStorage.setItem("raberu_printer_mac", this.selectedPrinter);
            }
          },
          loadPrinters() {
            if (window.Android && window.Android.getPairedPrinters) {
              const json = window.Android.getPairedPrinters();
              try {
                this.printers = JSON.parse(json);
                const saved = localStorage.getItem("raberu_printer_mac");
                if (saved && this.printers.some((p) => p.address === saved)) {
                  this.selectedPrinter = saved;
                } else if (this.printers.length > 0 && !this.selectedPrinter) {
                  this.selectedPrinter = this.printers[0].address;
                }
              } catch (e) {
                console.error("Failed to parse printers", e);
              }
            }
          },
          buildEscposText() {
            let out = "";
            this.printQueue.forEach((item) => {
              const name = item.nama;
              const price = this.formatPrice(item.harga);
              out += "[C]<b><font size='big'>" + name + "</font></b>\n";
              out += "[C]<b><font size='tall'>Rp " + price + "</font></b>\n";
              out += "\n";
            });
            out += "\n\n\n";
            return out;
          },
          printAll() {
            if (!(window.Android && window.Android.printRawTo)) {
              alert("Android bridge not available");
              return;
            }
            if (!this.selectedPrinter) {
              alert("Select a printer first");
              return;
            }
            const escpos = this.buildEscposText();
            window.Android.printRawTo(this.selectedPrinter, escpos);
            this.printQueue = [];
          },
          testPrint() {
            if (!(window.Android && window.Android.printRawTo)) {
              alert("Android bridge not available");
              return;
            }
            if (!this.selectedPrinter) {
              alert("Select a printer first");
              return;
            }
            const escpos =
              "[C]<b><font size='big'>Raberu Test</font></b>\n" +
              "[C]Hello from Vue\n\n\n";
            window.Android.printRawTo(this.selectedPrinter, escpos);
          },
        },
        watch: {
          selectedItems: {
            handler() {
              // Auto-add when items selected (optional)
            },
          },
        },
        mounted() {
          const saved = localStorage.getItem("raberu_printer_mac");
          if (saved) {
            this.selectedPrinter = saved;
          }
          this.loadPrinters();
        },
      }).mount("#app");
    </script>
  </body>
</html>
